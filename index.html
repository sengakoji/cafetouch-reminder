<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼(PCå‘ã‘)</title>
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒ" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" id="themeColorMeta" content="#06BBFA">
    <link rel="manifest" href="site.webmanifest" />
    <!-- Google Fonts: Roboto ã®èª­ã¿è¾¼ã¿ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        // å³åº§ã«è‰²ã¨ãƒ†ãƒ¼ãƒã‚’é©ç”¨ & é€šçŸ¥çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒ©ã¤ãé˜²æ­¢ï¼‰
        (function () {
            const saved = localStorage.getItem('cafeTouchSettings');
            if (saved) {
                const settings = JSON.parse(saved);

                const color = settings.primaryColor || '#06BBFA';
                const textColor = settings.textColor || 'white';
                document.documentElement.style.setProperty('--initial-color', color);
                document.documentElement.style.setProperty('--initial-text-color', textColor);

                const themeMeta = document.getElementById('themeColorMeta');
                if (themeMeta) themeMeta.setAttribute('content', color);

                if (settings.themeMode === 'dark') {
                    document.documentElement.classList.add('theme-dark');
                } else if (settings.themeMode === 'light') {
                    document.documentElement.classList.add('theme-light');
                }
            } else {
                document.documentElement.style.setProperty('--initial-color', '#06BBFA');
                document.documentElement.style.setProperty('--initial-text-color', 'white');
            }

            if (("Notification" in window) && (Notification.permission === 'granted')) {
                document.documentElement.style.setProperty('--notification-request-display', 'none');
            } else {
                document.documentElement.style.setProperty('--notification-request-display', 'block');
            }
        })();
    </script>
    <style>
        :root {
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;

            /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ©ã‚¤ãƒˆï¼‰å¤‰æ•° */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-charcoal-700);
            --color-text-secondary: var(--color-slate-500);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-control-bg: rgba(var(--color-brown-600-rgb), 0.08);
            --theme-scheme: light;
        }

        /* ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãŒãƒ€ãƒ¼ã‚¯ã€ã‹ã¤ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰å¼·åˆ¶ã§ãªã„å ´åˆ */
        @media (prefers-color-scheme: dark) {
            :root:not(.theme-light) {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: var(--color-gray-300);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-control-bg: rgba(119, 124, 124, 0.15);
                --theme-scheme: dark;
            }
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¼·åˆ¶ */
        :root.theme-dark {
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: var(--color-gray-300);
            --color-border: rgba(119, 124, 124, 0.3);
            --color-control-bg: rgba(119, 124, 124, 0.15);
            --theme-scheme: dark;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--color-background);
            color: var(--color-text);
            min-height: 100vh;
            transition: none;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--initial-color, #06BBFA);
            margin-bottom: 30px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: min(1.8rem, 6vw);
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0px 20px 40px 0px rgba(0, 0, 0, 0.05);
        }

        .status {
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            margin: 20px 0;
            position: relative;
        }

        .timer {
            grid-column: 2;
            font-size: 48px;
            font-weight: 500;
            color: var(--initial-color, #06BBFA);
            margin: 0;
            font-family: 'Roboto', sans-serif;
            font-variant-numeric: tabular-nums;
            width: 200px;
            text-align: center;
            transition: color 0.3s ease, opacity 0.3s ease;
        }

        .timer.placeholder {
            color: var(--color-text-secondary) !important;
            opacity: 0.35;
        }

        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            color: var(--initial-color, #06BBFA);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid transparent;
            outline: none;
        }

        .control-btn:hover {
            background: var(--color-control-bg);
            border-color: var(--color-border);
            transform: translateY(-1px);
        }

        .hover-warning:hover {
            background: rgba(227, 74, 69, 0.1) !important;
            border-color: rgba(227, 74, 69, 0.2) !important;
            color: #e34a45 !important;
            transform: translateY(-1px);
        }

        .hover-pause:hover {
            background: rgba(255, 193, 7, 0.1) !important;
            border-color: rgba(255, 193, 7, 0.2) !important;
            color: #FFC107 !important;
            transform: translateY(-1px);
        }

        .control-btn:active {
            transform: scale(0.9) translateY(0);
        }

        .reset-btn {
            grid-column: 1;
            justify-self: end;
            margin-right: 12px;
            color: var(--color-text-secondary);
            opacity: 0.6;
        }

        .reset-btn:hover {
            opacity: 1;
        }

        .mute-btn {
            grid-column: 3;
            justify-self: start;
            margin-left: 12px;
        }

        .mute-btn.muted {
            color: #e34a45;
            opacity: 0.7;
        }

        .mute-btn.muted:hover {
            background: rgba(227, 74, 69, 0.1) !important;
            border-color: rgba(227, 74, 69, 0.2) !important;
            color: #e34a45 !important;
            opacity: 1;
        }

        .next-time {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 15px;
            color: var(--color-text-secondary);
            margin: 16px 0 4px 0;
            letter-spacing: 0.02em;
            white-space: nowrap;
            width: 100%;
        }

        .info-part {
            width: 150px;
            transition: opacity 0.3s ease;
        }

        .info-part.placeholder {
            opacity: 0.35;
        }

        .info-left {
            text-align: right;
        }

        .info-right {
            text-align: left;
        }

        .info-center {
            width: 160px;
            text-align: center;
            font-weight: 500;
            color: var(--initial-color, #06BBFA);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease-out, opacity 0.2s, box-shadow 0.1s ease-out;
            margin-bottom: 12px;
            outline: none;
            user-select: none;
            box-shadow: 1px 2px 1px 2px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: visible;
        }

        .btn:active {
            transform: scale(0.99);
            box-shadow: 1px 2px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: var(--initial-color, #06BBFA);
            color: var(--initial-text-color, white);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .auto-update-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.45);
            width: 0%;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .btn-emphasis::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            box-shadow: 0 0 0 0 var(--initial-color, #06BBFA);
            animation: pulse-ring 1.5s cubic-bezier(0.24, 0, 0.38, 1) infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(var(--color-teal-500-rgb), 0.7);
            }

            100% {
                box-shadow: 0 0 0 9px rgba(var(--color-teal-500-rgb), 0);
            }
        }

        .btn-secondary {
            background: var(--color-control-bg);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        .show-only-when-notification-needed {
            display: var(--notification-request-display, block);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .segmented-control {
            display: flex;
            background: var(--color-control-bg);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .segmented-control input {
            display: none;
        }

        .segmented-control label {
            flex: 1;
            text-align: center;
            padding: 8px;
            margin: 0;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.1s;
            color: var(--color-text-secondary);
        }

        .segmented-control input:checked+label {
            background: var(--color-surface);
            color: var(--color-text);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-group input {
            width: auto;
            margin: 0;
        }

        .checkbox-group.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .checkbox-group.disabled input {
            cursor: not-allowed;
        }

        input[type="number"],
        input[type="time"],
        input[type="color"],
        input[type="text"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--color-surface);
            color: var(--color-text);
            color-scheme: var(--theme-scheme);
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            outline: 2px solid var(--color-teal-500);
            border-color: var(--color-teal-500);
        }

        .time-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .time-tag {
            background: var(--initial-color, #06BBFA);
            color: var(--initial-text-color, white);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 1px 2px 1px 2px rgba(0, 0, 0, 0.08);
            transition: transform 0.1s ease-out, opacity 0.2s;
        }

        .time-tag:hover {
            opacity: 0.9;
        }

        .time-tag.deleted {
            background: var(--color-control-bg) !important;
            color: var(--color-text-secondary) !important;
            animation: fadeInOut 8s ease-out forwards;
            box-shadow: none;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        /* ç’°å¢ƒåˆ¥è¡¨ç¤ºåˆ¶å¾¡ */
        .show-only-pc,
        .show-only-pwa,
        .show-only-mobile-browser {
            display: none;
        }

        .is-pc .show-only-pc {
            display: block;
        }

        .is-pwa .show-only-pwa {
            display: block;
        }

        .is-mobile-browser .show-only-mobile-browser {
            display: block;
        }

        .time-tag button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            line-height: 1;
            transition: transform 0.1s ease-out, opacity 0.2s;
        }

        .time-tag:not(.deleted):has(button:hover) {
            opacity: 0.4;
        }

        .time-tag button:hover {
            transform: translateY(0.8px) scale(1.2);
        }

        .settings-toggle {
            display: none;
        }

        .settings-content {
            display: none;
        }

        .settings-toggle:checked~.settings-content {
            display: block;
        }

        .toggle-label {
            cursor: pointer;
            display: block;
            text-align: center;
            padding: 12px;
            background: var(--color-control-bg);
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s ease-out, box-shadow 0.1s ease-out;
            user-select: none;
            box-shadow: 1px 2px 1px 2px rgba(0, 0, 0, 0.08);
        }

        .toggle-label:hover {
            background: var(--color-border);
        }

        .toggle-label:active {
            transform: scale(0.99);
            box-shadow: 1px 2px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .notification-status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .notification-enabled {
            background: rgba(var(--color-teal-500-rgb), 0.15);
            color: var(--color-teal-600);
            border: 1px solid rgba(var(--color-teal-500-rgb), 0.25);
        }

        .notification-disabled {
            background: rgba(192, 21, 47, 0.15);
            color: #c0152f;
            border: 1px solid rgba(192, 21, 47, 0.25);
        }

        .help-text {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }

        .color-preset {
            width: 100%;
            height: 40px;
            border: 2px solid var(--color-border);
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s ease-out;
        }

        .color-preset:hover {
            transform: scale(1.1);
            border-color: var(--color-teal-500);
        }

        .color-preset:active {
            transform: scale(0.9);
        }

        .footer-note {
            text-align: center;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 40px;
            padding-bottom: 20px;
        }

        .retroactive-panel {
            display: none;
            background: var(--color-control-bg);
            border-radius: 8px;
            padding: 16px;
            margin-top: 4px;
            margin-bottom: 12px;
            animation: fadeIn 0.2s ease-out;
        }

        .retroactive-panel input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: var(--color-border);
            border-radius: 4px;
            outline: none;
            margin: 8px 0;
        }

        .retroactive-panel input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--initial-color, #06BBFA);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--color-surface);
        }

        .retroactive-panel input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--initial-color, #06BBFA);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--color-surface);
        }

        .btn-text {
            background: none;
            border: none;
            font-size: 14px;
            color: var(--initial-color, #06BBFA);
            cursor: pointer;
            text-decoration: underline;
            padding: 8px 16px;
            transition: opacity 0.2s;
        }

        .btn-text:hover {
            opacity: 0.8;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <svg style="display: none;">
        <symbol id="icon-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </symbol>
    </svg>

    <div class="container">
        <h1>â˜• ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h1>

        <div id="notificationStatus"
            class="notification-status notification-disabled show-only-when-notification-needed">
            é€šçŸ¥ãŒç„¡åŠ¹ã§ã™ã€‚ã€Œé€šçŸ¥ã‚’è¨±å¯ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
        </div>

        <div id="initialSetupCard" class="card" style="display: none;">
            <h2 style="margin-top: 0; font-size: 18px;">åˆæœŸè¨­å®š</h2>

            <div class="form-group show-only-when-notification-needed"
                style="margin-top: 16px; padding: 12px; background: rgba(var(--color-teal-500-rgb), 0.08); border-radius: 8px; border: 1px solid rgba(var(--color-teal-500-rgb), 0.25);">
                <label
                    style="display: flex; align-items: center; gap: 8px; font-weight: 500; font-size: 14px; margin-bottom: 8px;">
                    <svg width="18" height="18">
                        <use href="#icon-bell"></use>
                    </svg>
                    é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                </label>
                <button class="btn btn-secondary" id="enableNotificationBtnInitial" onclick="enableNotifications()"
                    style="width: 100%; padding: 12px;">
                    é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹
                </button>
                <div class="help-text" style="margin-top: 8px;">
                    ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã§ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™
                </div>
            </div>

            <div class="form-group">
                <label>ã‚²ãƒ¼ãƒ å†…ã§ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹æ™‚åˆ»ï¼ˆæ¯æ—¥ã“ã®æ™‚é–“ã«ãƒªã‚»ãƒƒãƒˆï¼‰</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <label for="initialMorningTime" style="font-size: 12px; opacity: 0.8;">1å›ç›®</label>
                        <input type="time" id="initialMorningTime" value="04:00">
                    </div>
                    <div style="flex: 1;">
                        <label for="initialEveningTime" style="font-size: 12px; opacity: 0.8;">2å›ç›®</label>
                        <input type="time" id="initialEveningTime" value="16:00">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="initialActionTime">ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã«ã‹ã‹ã‚‹æ™‚é–“ï¼ˆç§’ï¼‰</label>
                <input type="number" id="initialActionTime" value="30" min="0">
                <div class="help-text">
                    ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®æ“ä½œã«ã‹ã‹ã‚‹ç§’æ•°ã§ã™<br>é€šçŸ¥å¾Œã«ã“ã®ç§’æ•°ã®é–“å¾…æ©Ÿã—ã¦ã€è‡ªå‹•ã§æ¬¡ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã—ã¾ã™
                </div>
            </div>

            <div class="help-text"
                style="margin-top: 20px; border-top: 1px solid var(--color-border); padding-top: 12px;">
                ğŸ’¡ ã“ã‚Œã‚‰ã®è¨­å®šã‚„ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã®æ™‚é–“ã¯ã€ä¸‹ã®ã€Œè¨­å®šã€ã‹ã‚‰ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™
            </div>

            <div style="height: 16px;"></div>
            <button class="btn btn-primary" id="initialSetupConfirmBtn">ã“ã®å†…å®¹ã§é–‹å§‹ã™ã‚‹</button>
        </div>

        <div class="card">
            <div class="status">
                <div class="timer-container">
                    <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ (ã‚¿ã‚¤ãƒãƒ¼å·¦éš£ãƒ»å¯¾ç§°) -->
                    <button id="resetTimerBtn" class="control-btn reset-btn hover-warning" onclick="resetTimer()"
                        title="ã‚¿ã‚¤ãƒãƒ¼ã‚’è§£é™¤ã—ã¦å›ºå®šæ™‚é–“ã‚’å¾…ã¤">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                    </button>

                    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒãƒ¼ -->
                    <div class="timer" id="timer">00:00:00</div>

                    <!-- ãƒ™ãƒ«ãƒœã‚¿ãƒ³ (å³éš£) -->
                    <button id="muteBtn" class="control-btn mute-btn hover-pause" onclick="toggleMute()"
                        title="é€šçŸ¥ã‚’ä¸€æ™‚åœæ­¢/å†é–‹">
                        <svg id="bellIconOn" width="28" height="28" fill="currentColor" fill-opacity="0.15">
                            <use href="#icon-bell"></use>
                        </svg>
                        <svg id="bellIconOff" width="28" height="28" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="display: none;">
                            <path d="M10.3 4.5A6 6 0 0 1 18 8c0 2.22.63 4.14 1.3 5.4" stroke-opacity="0.5"></path>
                            <path d="M11.8 3.5a6 6 0 0 0-5.8 4.5c0 2.5-.5 4.8-1.3 6" stroke-opacity="0.5"></path>
                            <path d="M3 17h16" stroke-opacity="0.5"></path>
                            <path d="M10.3 21a2 2 0 0 0 3.4 0" stroke-opacity="0.5"></path>
                            <line x1="2" y1="2" x2="22" y2="22" stroke="#e34a45" stroke-width="2.5"></line>
                        </svg>
                    </button>
                </div>
                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãƒ©ã‚¤ãƒ³ -->
                <div class="next-time" id="nextTime">
                    <span class="info-part info-left" id="lastTouchDisplay">å‰å› 00:00:00</span>
                    <span class="info-center" id="statusDisplay"></span>
                    <span class="info-part info-right" id="nextTouchDisplay">æ¬¡å› 00:00:00</span>
                </div>
            </div>
            <button class="btn btn-primary" id="completedBtn" onclick="markCompleted()">
                âœ“ ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†
                <div id="autoUpdateBar" class="auto-update-bar"></div>
            </button>
            <button id="retroactiveModeBtn" class="btn btn-secondary"
                onclick="toggleRetroactiveMode()">ã‚¿ãƒƒãƒã—ãŸæ™‚åˆ»ã‚’å…¥åŠ›</button>

            <!-- é¡ã£ã¦å®Œäº†ç™»éŒ²æ©Ÿèƒ½ãƒ‘ãƒãƒ« -->
            <div id="retroactivePanel" class="retroactive-panel">
                <div class="form-group" style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: center;">
                        <input type="time" id="retroactiveTimeInput" onchange="syncSliderFromTime()"
                            style="font-size: 28px; text-align: center; width: auto; padding: 4px 16px; font-weight: 600; border-color: var(--initial-color, #06BBFA);">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 8px;">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 12px; color: var(--color-text-secondary); margin-bottom: 4px;">
                        <span id="retroactiveSliderLabelMin">3æ™‚é–“å‰</span>
                        <span>ç¾åœ¨</span>
                    </div>
                    <input type="range" id="retroactiveSlider" min="-180" max="0" value="0" step="1"
                        oninput="syncTimeFromSlider()" style="width: 100%; cursor: pointer;">
                </div>

                <label id="retroactiveRangeLabel"
                    style="text-align: center; margin-bottom: 16px; font-weight: normal; opacity: 0.8;">å‰å›ã‚¿ãƒƒãƒã—ãŸæ™‚åˆ»ã‚’è¨­å®šã—ã¦ãã ã•ã„</label>

                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" style="flex: 2; padding: 12px;"
                        onclick="toggleRetroactiveMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="btn btn-primary" style="flex: 3; padding: 12px;"
                        onclick="confirmRetroactive()">æ±ºå®š</button>
                </div>
            </div>
        </div>

        <div class="card">
            <input type="checkbox" id="settingsToggle" class="settings-toggle">
            <label for="settingsToggle" class="toggle-label">âš™ï¸ è¨­å®šã‚’é–‹ã/é–‰ã˜ã‚‹</label>

            <div class="settings-content">
                <!-- ã‚°ãƒ«ãƒ¼ãƒ—1: å‹•ä½œ -->
                <div class="form-group">
                    <label class="checkbox-group" style="margin-bottom: 8px;">
                        <input type="checkbox" id="autoUpdateNextInput" checked>
                        é€šçŸ¥ã‹ã‚‰æ“ä½œæ™‚é–“çµŒéå¾Œã«è‡ªå‹•ã§æ¬¡ã®äºˆå®šã‚’ã‚»ãƒƒãƒˆã™ã‚‹
                    </label>
                    <div class="help-text">ã‚ªãƒ•ã«ã™ã‚‹ã¨ã€é€šçŸ¥å¾Œã«ã€Œã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§å¾…æ©Ÿã—ã¾ã™</div>

                </div>

                <hr style="border: 0; border-top: 1px solid var(--color-border); margin: 24px 0;">

                <!-- ã‚°ãƒ«ãƒ¼ãƒ—2: é€šçŸ¥ãƒ»è¡¨ç¤º -->
                <div class="form-group">
                    <label class="checkbox-group" style="margin-bottom: 8px;">
                        <input type="checkbox" id="notifyOnCompleteInput">
                        å®Œäº†æ™‚ã«é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹
                    </label>
                    <div class="help-text">ã€Œã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸéš›ã«ã‚‚é€šçŸ¥ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™</div>

                    <label class="checkbox-group" style="margin-top: 12px; margin-bottom: 8px;">
                        <input type="checkbox" id="notificationSoundInput" checked>
                        é€šçŸ¥æ™‚ã«éŸ³ã‚’é³´ã‚‰ã™
                    </label>
                    <div class="help-text">â€»OSã‚„ãƒ–ãƒ©ã‚¦ã‚¶å´ã®é€šçŸ¥è¨­å®šãŒå„ªå…ˆã•ã‚Œã¾ã™</div>

                    <div class="show-only-pc" style="margin-top: 12px; margin-bottom: 4px;">
                        <label class="checkbox-group">
                            <input type="checkbox" id="requireInteractionInput" onchange="toggleFocusSetting()">
                            é€šçŸ¥ã‚’è‡ªå‹•ã§æ¶ˆã•ãªã„ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å®Œäº†ï¼‰
                        </label>
                        <div class="help-text">æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ãƒªãƒã‚¤ãƒ³ãƒ‰é€šçŸ¥ãŒç”»é¢ã«æ®‹ã‚Šç¶šã‘ã¾ã™ã€‚<br>é€šçŸ¥ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Œã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ã€ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚</div>

                        <div style="margin-left: 24px; margin-top: 8px;">
                            <label class="checkbox-group" id="preventFocusContainer">
                                <input type="checkbox" id="preventFocusOnNotificationClickInput">
                                é€šçŸ¥ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã‹ãªã„
                            </label>
                            <div class="help-text">æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æœ€å‰é¢ã«è¡¨ç¤ºã—ã¾ã›ã‚“</div>
                        </div>
                    </div>

                    <!-- PWAå°‚ç”¨: é€šçŸ¥è¨­å®šã®æ¡ˆå†… -->
                    <div id="pwaAdvancedSettings" class="show-only-mobile-pwa"
                        style="margin-top: 16px; padding: 16px; background: rgba(var(--color-teal-500-rgb), 0.05); border-radius: 12px; border: 1px solid rgba(var(--color-teal-500-rgb), 0.1); display: none;">
                        <h4 style="margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">ğŸš€</span> PWA ç‰ˆ é€šçŸ¥è¨­å®šã‚¬ã‚¤ãƒ‰
                        </h4>

                        <div class="help-text" style="margin-bottom: 12px; font-size: 13px;" id="pwaNotifDesc">
                            ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆç”»é¢ä¸Šéƒ¨ã¸ã®é€šçŸ¥ï¼‰ã‚„ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæŒ¯å‹•ï¼‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€OSå´ã®è¨­å®šå¤‰æ›´ãŒå¿…è¦ã§ã™ã€‚
                        </div>

                        <div id="pwaGuidePath" class="help-text"
                            style="padding: 10px; background: var(--color-surface); border-radius: 6px; border-left: 3px solid var(--color-teal-500); font-size: 13px; margin-bottom: 16px;">
                            ğŸ’¡ å‹•ä½œã—ãªã„å ´åˆã¯ã€ãƒ‡ãƒã‚¤ã‚¹ã®<br>
                            <span id="pwaOSPathText" style="font-weight: 500;">[è¨­å®š] &gt; [é€šçŸ¥]</span><br>
                            ã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„
                        </div>

                        <button class="btn btn-secondary" style="width: 100%; font-size: 13px; padding: 8px;"
                            onclick="checkNotificationPermissionManual()">
                            ğŸ”” OSè¨­å®šã‚’ç¢ºèªã™ã‚‹æ‰‹é †
                        </button>
                    </div>


                    <!-- éPWAãƒ¢ãƒã‚¤ãƒ«ç”¨: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«èª˜å° -->
                    <div class="show-only-mobile-browser"
                        style="margin-top: 16px; padding: 12px; background: rgba(var(--color-teal-500-rgb), 0.05); border-radius: 8px; border: 1px dashed rgba(var(--color-teal-500-rgb), 0.3); font-size: 13px;">
                        <strong>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰</strong>ã™ã‚‹ã¨ã€ç«¯æœ«ã®æŒ¯å‹•ã‚„ç”»é¢ä¸Šéƒ¨ã¸ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é€šçŸ¥ãŒã‚¢ãƒ—ãƒªã”ã¨ã«è¨­å®šã—ã‚„ã™ããªã‚Šã¾ã™ã€‚
                        Androidç‰ˆMicrosoft Edgeã‚’ãŠä½¿ã„ã®æ–¹ã¯ã€è¨­å®šã®é …ç›®ãŒç•°ãªã‚‹ãŸã‚ä¸€æ™‚çš„ã«Google Chromeã‚’ä½¿ç”¨ã—ã¦ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ (ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

                        <!-- Chromeé™å®šã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ (beforeinstallpromptãŒæ¥ãŸæ™‚ã®ã¿è¡¨ç¤º) -->
                        <button id="pwaInstallBtn" class="btn btn-secondary"
                            style="margin-top: 12px; padding: 10px; font-size: 13px; display: none;">
                            ğŸ“² ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹
                        </button>

                        <!-- iOS/iPadOS å‘ã‘ã‚¬ã‚¤ãƒ‰ (JSã§ isIOS && !isStandalone ã®æ™‚ã®ã¿è¡¨ç¤º) -->
                        <div id="iosInstallGuide"
                            style="display: none; margin-top: 12px; padding: 10px; background: var(--color-surface); border-radius: 6px; border-left: 3px solid var(--color-teal-500); line-height: 1.6;">
                            ğŸ“¤ ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®è¿½åŠ æ–¹æ³•ï¼š<br>
                            ãƒ–ãƒ©ã‚¦ã‚¶ã®<strong>å…±æœ‰ãƒœã‚¿ãƒ³</strong>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€
                            <strong>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</strong>ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>
                            <span style="color: var(--color-text-secondary); font-size: 12px;">
                                â€» Safari ã§ã¯ç”»é¢ä¸‹éƒ¨ã€Chromeãƒ»Edge ã§ã¯
                                ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ä»˜è¿‘ã¾ãŸã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã«ã‚ã‚Šã¾ã™ã€‚
                            </span>
                        </div>
                    </div>

                    <label class="checkbox-group" style="margin-top: 12px;">
                        <input type="checkbox" id="showTitleTimerInput" checked>
                        ã‚¿ãƒ–ã®ã‚¿ã‚¤ãƒˆãƒ«ã«æ®‹ã‚Šæ™‚é–“ã‚’è¡¨ç¤ºã™ã‚‹
                    </label>
                    <div class="help-text">åˆ¥ã®ã‚¿ãƒ–ã‚’è¦‹ã¦ã„ã¦ã‚‚çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆåˆ†å˜ä½ã®è¡¨ç¤ºï¼‰</div>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--color-border); margin: 24px 0;">

                <!-- ã‚°ãƒ«ãƒ¼ãƒ—3: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®šãƒ»çŠ¶æ…‹ãƒ»ãƒ†ã‚¹ãƒˆ -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; margin-bottom: 16px;">ğŸ’¬ é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­å®š</h3>

                    <div class="form-group">
                        <label>ãƒªãƒã‚¤ãƒ³ãƒ‰é€šçŸ¥ï¼ˆæ™‚é–“ã«ãªã£ãŸæ™‚ï¼‰</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <input type="text" id="remindTitleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®æ™‚é–“ã§ã™ï¼)"
                                oninput="saveSettingsAuto()">
                            <input type="text" id="remindBodyInput" placeholder="æœ¬æ–‡ (ä¾‹: ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã‚’å¿˜ã‚Œãšã«â™ª)"
                                oninput="saveSettingsAuto()">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 24px;">
                        <label>å®Œäº†é€šçŸ¥ï¼ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ï¼‰</label>
                        <input type="text" id="completeTitleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ï¼)"
                            oninput="saveSettingsAuto()">
                        <div class="help-text">æœ¬æ–‡ã¯ã€Œ>> HH:mm:ssã€å½¢å¼ã§å›ºå®šã•ã‚Œã¾ã™</div>
                    </div>

                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <div id="notificationStatusInSettings" class="help-text" style="font-weight: 500;">é€šçŸ¥çŠ¶æ…‹: æœªç¢ºèª
                        </div>
                        <div class="show-only-when-notification-needed">
                            <button class="btn btn-secondary" id="enableNotificationBtn" onclick="enableNotifications()"
                                style="width: auto; padding: 10px 24px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <svg width="18" height="18">
                                    <use href="#icon-bell"></use>
                                </svg>
                                é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹
                            </button>
                        </div>
                        <button class="btn btn-secondary"
                            style="width: auto; padding: 10px 24px; margin-bottom: 0; display: flex; align-items: center; gap: 8px;"
                            onclick="sendTestNotification()">
                            <svg width="18" height="18">
                                <use href="#icon-bell"></use>
                            </svg>
                            ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ã‚‹
                        </button>
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--color-border); margin: 24px 0;">

                <div class="form-group">
                    <label>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 12px;">
                        <!-- 1è¡Œç›®ï¼šå­¦åœ’ã‚«ãƒ©ãƒ¼ -->
                        <button class="color-preset" style="background: #06BBFA;"
                            onclick="setColor('#06BBFA')"></button>
                        <button class="color-preset" style="background: #E34A45;"
                            onclick="setColor('#E34A45')"></button>
                        <button class="color-preset" style="background: #4F86F7;"
                            onclick="setColor('#4F86F7')"></button>
                        <button class="color-preset" style="background: #FBB35A;"
                            onclick="setColor('#FBB35A')"></button>
                        <button class="color-preset" style="background: #E05289;"
                            onclick="setColor('#E05289')"></button>

                        <!-- 2è¡Œç›® -->
                        <button class="color-preset" style="background: #03C03C;"
                            onclick="setColor('#03C03C')"></button>
                        <button class="color-preset" style="background: #B23B59;"
                            onclick="setColor('#B23B59')"></button>
                        <button class="color-preset" style="background: #A1A9E1;"
                            onclick="setColor('#A1A9E1')"></button>
                        <button class="color-preset" style="background: #DBDAD8;"
                            onclick="setColor('#DBDAD8')"></button>
                        <button class="color-preset" style="background: #90ABC9;"
                            onclick="setColor('#90ABC9')"></button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <input type="color" id="colorPicker" value="#06BBFA"
                            style="width: 33.3%; height: 44px; cursor: pointer;" onchange="setColor(this.value)">
                        <span style="font-size: 20px;">ğŸ¨</span>
                    </div>
                    <div class="help-text">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚«ãƒ©ãƒ¼ã‚’é¸æŠã™ã‚‹ã‹ã€ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã§è‡ªç”±ã«è‰²ã‚’è¨­å®šã§ãã¾ã™</div>
                </div>

                <div class="form-group">
                    <label>ã‚«ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="segmented-control">
                        <input type="radio" id="theme-system" name="themeMode" value="system"
                            onchange="setThemeMode(this.value)">
                        <label for="theme-system">ã‚·ã‚¹ãƒ†ãƒ </label>
                        <input type="radio" id="theme-light" name="themeMode" value="light"
                            onchange="setThemeMode(this.value)">
                        <label for="theme-light">ãƒ©ã‚¤ãƒˆ</label>
                        <input type="radio" id="theme-dark" name="themeMode" value="dark"
                            onchange="setThemeMode(this.value)">
                        <label for="theme-dark">ãƒ€ãƒ¼ã‚¯</label>
                    </div>
                    <div class="help-text">ç”»é¢ã®æ˜ã‚‹ã•ã‚’è¨­å®šã—ã¾ã™ã€‚ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚’é¸ã¶ã¨ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã«å¾“ã„ã¾ã™ï¼‰</div>
                </div>

                <div class="form-group">
                    <label>ãƒœã‚¿ãƒ³å†…ã¨ä¸€éƒ¨ã®æ–‡å­—è‰²</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="flex: 1; padding: 12px; color: white;" data-fixed-color
                            onclick="setTextColor('white')">ã‚µãƒ³ãƒ—ãƒ« ç™½</button>
                        <button class="btn btn-primary" style="flex: 1; padding: 12px; color: black;" data-fixed-color
                            onclick="setTextColor('black')">ã‚µãƒ³ãƒ—ãƒ« é»’</button>
                    </div>
                    <div class="help-text">ãƒœã‚¿ãƒ³ã¨å›ºå®šæ™‚é–“ã‚¿ã‚°ã®æ–‡å­—è‰²ã‚’è¨­å®šã—ã¾ã™</div>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--color-border); margin: 24px 0;">

                <div class="form-group">
                    <label>ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆåˆ†ï¼‰</label>
                    <input type="number" id="cooldownInput" value="180" min="1" oninput="saveSettingsAndRecalculate()"
                        style="width: 120px;">
                    <div class="help-text">ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå¾Œã®ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã€æ¬¡ã«ã‚¿ãƒƒãƒã§ãã‚‹ã¾ã§ã®æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 180åˆ† = 3æ™‚é–“ï¼‰</div>
                </div>

                <div class="form-group">
                    <label>ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã«ã‹ã‹ã‚‹æ™‚é–“ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="actionTimeInput" value="30" min="0" oninput="saveSettingsAndRecalculate()"
                        style="width: 120px;">
                    <div class="help-text">ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®æ“ä½œã«ã‹ã‹ã‚‹æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 30ç§’ï¼‰<br>é€šçŸ¥ã‹ã‚‰ã“ã®æ™‚é–“ãŒçµŒéã™ã‚‹ã¨è‡ªå‹•ã§æ¬¡ã®äºˆå®šãŒã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</div>
                </div>

                <div class="form-group show-only-mobile">
                    <label>é€šçŸ¥ã‚’æ—©ã‚ã‚‹æ™‚é–“ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="notificationAdvanceInput" value="0" min="0" max="120"
                        oninput="saveSettingsAuto()" style="width: 120px;">
                    <div class="help-text">é€šä¿¡ç’°å¢ƒã«ã‚ˆã‚‹é…å»¶ã‚’è£œæ­£ã™ã‚‹ãŸã‚ã€äºˆå®šæ™‚åˆ»ã®ä½•ç§’å‰ã«é€šçŸ¥ã‚’é€ã‚‹ã‹è¨­å®šã§ãã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ç§’ï¼‰</div>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--color-border); margin: 24px 0;">

                <div class="form-group">
                    <label>å›ºå®šãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ï¼ˆè¤‡æ•°è¨­å®šå¯èƒ½ï¼‰</label>
                    <div id="addFixedTimeContainer"
                        style="display: flex; gap: 8px; align-items: center; min-height: 44px;">
                        <!-- åˆæœŸçŠ¶æ…‹: è¿½åŠ ãƒœã‚¿ãƒ³ã®ã¿ -->
                        <button id="showAddFixedTimeBtn" class="btn btn-secondary"
                            style="margin-bottom: 0; padding: 10px 16px; font-size: 14px;"
                            onclick="showAddFixedTimeMode()">
                            <span style="font-size: 16px; font-weight: bold; margin-right: 4px;">+</span> æ™‚åˆ»ã‚’è¿½åŠ 
                        </button>

                        <!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰æ™‚ (åˆæœŸéè¡¨ç¤º) -->
                        <div id="addFixedTimeInputGroup"
                            style="display: none; align-items: center; gap: 8px; width: 100%;">
                            <input type="time" id="fixedTimeInput" style="flex: 1; height: 44px;">
                            <button class="btn btn-primary" style="width: auto; padding: 10px 20px; margin-bottom: 0;"
                                onclick="addFixedTime()">æ±ºå®š</button>
                            <button class="btn btn-secondary" style="width: auto; padding: 10px 12px; margin-bottom: 0;"
                                onclick="hideAddFixedTimeMode()">âœ•</button>
                        </div>
                    </div>
                    <div class="time-list" id="fixedTimesList"></div>
                    <div class="help-text">ä¾‹: 4:00, 16:00 ãªã©ã€æ¯æ—¥ã“ã®æ™‚åˆ»ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</div>
                </div>

                <div class="card" style="background: rgba(var(--color-teal-500-rgb), 0.08); margin-top: 20px;">
                    <h3 style="margin-top: 0;">æ“ä½œèª¬æ˜</h3>

                    <div style="font-size: 14px; line-height: 1.5;">
                        <p>ãƒ–ãƒ«ãƒ¼ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é€šçŸ¥ã™ã‚‹ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã§ã™ã€‚<br>
                            PCãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã€Œå®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ã€ã§å®‰å®šå‹•ä½œã—ã€ã‚¹ãƒãƒ›ï¼ˆAndroidï¼‰ã§ã¯ã€Œã‚¯ãƒ©ã‚¦ãƒ‰çµŒç”±ï¼ˆCloudflare Workerï¼‰ã€ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥ã‚’è¡Œã„ã¾ã™ã€‚</p>

                        <!-- ã‚¹ãƒãƒ›ç’°å¢ƒç”¨ã®ãŠè©«ã³æ–‡ãƒ»ç’°å¢ƒã”ã¨ã®é•ã„ -->
                        <div id="instructionNotice"
                            style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 13px; line-height: 1.5;">
                            <strong style="color: #FFC107;">ğŸ“± ã‚¹ãƒãƒ›ç’°å¢ƒã§ã®ã”åˆ©ç”¨ã«ã¤ã„ã¦</strong>
                            <ul style="margin: 8px 0 0 0; padding-left: 20px; color: var(--color-text-secondary);">
                                <li><strong>å…±é€š</strong>:
                                    ã‚¯ãƒ©ã‚¦ãƒ‰çµŒç”±ã§Pushé€šçŸ¥ã‚’é€ã‚‹ãŸã‚ã€ç’°å¢ƒã‚„ç„¡æ–™æ ã®åˆ¶é™ã«ã‚ˆã‚Šé€šçŸ¥ãŒ10ç§’ã€œæ•°åˆ†ç¨‹åº¦é…ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
                                <li><strong>Android</strong>:
                                    ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰ã™ã‚‹ã¨ã€æŒ¯å‹•ãƒ»ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é€šçŸ¥ã®è¨­å®šãŒè¡Œã„ã‚„ã™ããªã‚Šã¾ã™ã€‚</li>
                                <li><strong>iOS (iPhone)</strong>:
                                    ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã—ã¦èµ·å‹•ã—ãªã„ã¨Web Pushé€šçŸ¥ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã¾ãŸã€iOSã®ä»•æ§˜ä¸Šãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®é•·æ™‚é–“ã®è‡ªå‹•æ›´æ–°ãŒä¸å®‰å®šã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                                </li>
                            </ul>
                        </div>

                        <p id="instructionAutoUpdate"><strong>è‡ªå‹•æ›´æ–°</strong><br>
                            é€šçŸ¥å¾Œã«ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ãšã«æ”¾ç½®ã™ã‚‹ã¨ã€<br>ã€Œã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã«ã‹ã‹ã‚‹æ™‚é–“ã€+ã€Œã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã€ãŒ<br>æ¬¡å›ã®é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«è‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã¾ã™ã€‚</p>

                        <p id="instructionManualUpdate"><strong>æ‰‹å‹•æ›´æ–°</strong><br>
                            ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒãŒäºˆå®šæ™‚åˆ»ã‚ˆã‚Šé…ã‚ŒãŸå ´åˆã‚„ã€Œã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã‹ã‚‰ã€æœ€çŸ­ã®ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã‚’è¨ˆã‚ŠãŸã„å ´åˆã¯ã€Œã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã®ã¿ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚
                        </p>

                        <p id="instructionChangeSettings" style="font-size: 13px; opacity: 0.8; margin-top: 12px;">
                            æ“ä½œæ™‚é–“ã‚„ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã¯è¨­å®šç”»é¢ã‹ã‚‰å¤‰æ›´å¯èƒ½ã§ã™ã€‚
                        </p>
                    </div>
                </div>

                <div
                    style="margin-top: 32px; border-top: 1px solid var(--color-border); padding-top: 16px; text-align: center;">
                    <button class="btn-text" style="color: #c0152f; font-size: 13px;" onclick="resetApp()">âš ï¸
                        ã™ã¹ã¦ã®è¨­å®šã‚’å‰Šé™¤ã™ã‚‹</button>
                    <div class="help-text">è¨­å®šãªã©ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™</div>
                </div>

            </div>
        </div>

        <div class="footer-note show-only-pc">ğŸ’¡ é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯ã€ã“ã®ã‚¿ãƒ–ã‚’é–‹ã„ãŸã¾ã¾ã«ã—ã¦ãŠã„ã¦ãã ã•ã„</div>
    </div>

    <script>
        let fixedTimes = [];
        let cooldownMinutes = 180;
        let actionTimeSeconds = 30;
        let notificationAdvanceSeconds = 0;

        // --- Web Push Settings ---
        const VAPID_PUBLIC_KEY = 'BDhsA4_i9Dd6zh0p0QoGCL-tyXG1rTbmqz_1-l3KE0qtViJ01pS25EDZeaBGn0jnDR2YLTezFHX8qFcEPBNI4Lg';
        const WORKER_URL = 'https://cafe-push-worker.laid-tiles.workers.dev'; // ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®Worker URL

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }



        function getNotificationSettings() {
            if (isMobile) {
                // ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã§ã¯å¸¸ã«OSã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚„æŒ¯å‹•ã‚’å§”ã­ã‚‹ãŸã‚ã€ä½™è¨ˆãªãƒ•ãƒ©ã‚°ã‚’é€ã‚‰ãªã„
                return {
                    requireInteraction: false,
                };
            }
            return {
                requireInteraction: document.getElementById('requireInteractionInput')?.checked || false,
            };
        }

        async function syncScheduleToWorker(targetDate) {
            if (!targetDate) return;
            const now = new Date().getTime();
            // å‰å€’ã—ç§’ã‚’é©ç”¨ï¼šäºˆå®šæ™‚åˆ»ã® advanceSeconds å‰ã«é€šçŸ¥ãŒå±Šãã‚ˆã†ã« delaySeconds ã‚’çŸ­ç¸®ã™ã‚‹
            const rawDelay = Math.floor((targetDate.getTime() - now) / 1000);
            const delaySeconds = Math.max(0, rawDelay - notificationAdvanceSeconds);

            // éå»ã®å ´åˆã¯ä¸è¦
            if (rawDelay <= 0) return;

            const subStr = localStorage.getItem('pushSubscription');
            if (!subStr) return;
            const subscription = JSON.parse(subStr);

            const settings = getNotificationSettings();

            try {
                await fetch(`${WORKER_URL}/schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription,
                        delaySeconds,
                        payload: {
                            title: remindTitle,
                            body: remindBody,
                            requireInteraction: settings.requireInteraction,
                            enableVibration: settings.enableVibration
                        },
                        // è‡ªå‹•æ¬¡å›ç™»éŒ²ç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆWorkerå´ã§æ¬¡ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è‡ªå‹•æŠ•å…¥ã™ã‚‹ï¼‰
                        autoUpdate: autoUpdateNext,
                        cooldownMinutes: cooldownMinutes,
                        actionTimeSeconds: actionTimeSeconds,
                        advanceSeconds: notificationAdvanceSeconds,
                        fixedTimes: fixedTimes
                    })
                });
                console.log('Worker Sync: Scheduled in', delaySeconds, 'seconds (autoUpdate:', autoUpdateNext, ', advance:', notificationAdvanceSeconds, ')');
            } catch (e) {
                console.error('Worker Sync Failed:', e);
            }
        }
        // -------------------------
        let notifyOnComplete = false;
        let notificationSound = true;
        let requireInteraction = false;
        let preventFocusOnNotificationClick = false;
        let preventSleep = true;
        let showTitleTimer = true;
        let autoUpdateNext = true;
        let muteNotifications = false; // é€šçŸ¥ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹
        let themeMode = 'system';
        let nextNotificationTime = null;
        let lastNotifiedTime = null;
        let lastCompletedTime = null;
        let pendingAutoUpdateTime = null;
        let isDelayedNotification = false;
        let enableVibration = true; // PWAå‘ã‘ï¼šæŒ¯å‹•è¨­å®š

        let remindTitle = "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®æ™‚é–“ã§ã™ï¼";
        let remindBody = "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã‚’å¿˜ã‚Œãšã«â™ª";
        let completeTitle = "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ï¼";

        let notificationPermission = false;
        let lastScheduledSource = 'fixed';
        let primaryColor = '#06BBFA';
        let textColor = 'white';
        let isInitialSetupDone = false;

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        // Edgeåˆ¤å®š: PCç‰ˆã¯ Edg/ã€Androidç‰ˆã¯ EdgA/ ã‚’ä½¿ã†ã®ã§ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ãªã—ã§ä¸¡æ–¹ã‚­ãƒ£ãƒƒãƒ
        const isEdge = /Edg/i.test(navigator.userAgent);
        // Chromeåˆ¤å®š (Edgeã¯Chromeã®UAã‚‚æŒã¤ã®ã§é™¤å¤–)
        const isChrome = /Chrome\//i.test(navigator.userAgent) && !isEdge;

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆChrome Android é™å®šï¼‰
        let _pwaInstallPrompt = null;
        const _pwaInstallBtn = document.getElementById('pwaInstallBtn');

        // beforeinstallprompt ã¯ Chrome(Android) ã®ã¿ç™ºç«ã™ã‚‹
        // isEdge / isIOS / isStandalone ã®ã¨ãã¯ãƒªã‚¹ãƒŠãƒ¼ã‚’ç„¡è¦–ã¾ãŸã¯ãƒœã‚¿ãƒ³ã‚’å‡ºã•ãªã„
        window.addEventListener('beforeinstallprompt', (e) => {
            if (isStandalone || isEdge || isIOS) return; // å¯¾è±¡å¤–ã¯ç„¡è¦–
            e.preventDefault();
            _pwaInstallPrompt = e;
            if (_pwaInstallBtn) _pwaInstallBtn.style.display = 'block';
        });

        if (_pwaInstallBtn) {
            _pwaInstallBtn.addEventListener('click', async () => {
                if (!_pwaInstallPrompt) return;
                _pwaInstallPrompt.prompt();
                const { outcome } = await _pwaInstallPrompt.userChoice;
                if (outcome === 'accepted') {
                    _pwaInstallPrompt = null;
                    _pwaInstallBtn.style.display = 'none';
                }
            });
        }

        window.addEventListener('appinstalled', () => {
            _pwaInstallPrompt = null;
            if (_pwaInstallBtn) _pwaInstallBtn.style.display = 'none';
        });

        // iOS/iPadOSå‘ã‘: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ãŒä½¿ãˆãªã„ã®ã§å…±æœ‰çµŒç”±ã®æ‰‹é †ã‚’æ¡ˆå†…
        if (isIOS && !isStandalone) {
            const iosGuide = document.getElementById('iosInstallGuide');
            if (iosGuide) iosGuide.style.display = 'block';
        }

        let retroactiveBaseTime = null;

        let worker = null;
        let mainInterval = null;

        const workerCode = `
            let timer = null;
            function startTimer(interval) {
                if (timer) clearInterval(timer);
                timer = setInterval(() => self.postMessage('tick'), interval);
            }
            self.onmessage = (e) => {
                if (e.data.type === 'setRate') startTimer(e.data.interval);
                if (e.data.type === 'stop') clearInterval(timer);
            };
            startTimer(200);
        `;

        function updateTimerSystem() {
            if (worker) {
                worker.postMessage({ type: 'stop' });
                worker.terminate();
                worker = null;
            }
            if (mainInterval) {
                clearInterval(mainInterval);
                mainInterval = null;
            }

            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const objectUrl = URL.createObjectURL(blob);
            worker = new Worker(objectUrl);
            URL.revokeObjectURL(objectUrl); // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã®ãŸã‚URLã‚’è§£æ”¾
            worker.onmessage = () => updateTimerLogic();
            setWorkerRate(document.hidden ? 1000 : 200);
        }

        function setWorkerRate(interval) {
            if (worker) worker.postMessage({ type: 'setRate', interval: interval });
        }

        function loadSettings() {
            const saved = localStorage.getItem('cafeTouchSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                fixedTimes = settings.fixedTimes || [];
                primaryColor = settings.primaryColor || '#06BBFA';
                textColor = settings.textColor || 'white';
                cooldownMinutes = settings.cooldownMinutes || 180;
                actionTimeSeconds = settings.actionTimeSeconds || 30;
                notificationAdvanceSeconds = settings.notificationAdvanceSeconds || 0;
                notifyOnComplete = settings.notifyOnComplete || false;
                notificationSound = settings.notificationSound !== undefined ? settings.notificationSound : true;
                requireInteraction = settings.requireInteraction !== undefined ? settings.requireInteraction : false;
                preventFocusOnNotificationClick = settings.preventFocusOnNotificationClick !== undefined ? settings.preventFocusOnNotificationClick : false;
                preventSleep = true; // å¸¸ã«æœ‰åŠ¹åŒ–
                showTitleTimer = settings.showTitleTimer !== undefined ? settings.showTitleTimer : true;
                autoUpdateNext = settings.autoUpdateNext !== undefined ? settings.autoUpdateNext : true;
                muteNotifications = settings.muteNotifications !== undefined ? settings.muteNotifications : false;
                themeMode = settings.themeMode || 'system';
                nextNotificationTime = settings.nextNotificationTime ? new Date(settings.nextNotificationTime) : null;
                lastNotifiedTime = settings.lastNotifiedTime ? new Date(settings.lastNotifiedTime) : null;
                lastCompletedTime = settings.lastCompletedTime ? new Date(settings.lastCompletedTime) : null;
                pendingAutoUpdateTime = settings.pendingAutoUpdateTime ? new Date(settings.pendingAutoUpdateTime) : null;
                isDelayedNotification = settings.isDelayedNotification || false;

                remindTitle = settings.remindTitle || "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®æ™‚é–“ã§ã™ï¼";
                remindBody = settings.remindBody || "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã‚’å¿˜ã‚Œãšã«â™ª";
                completeTitle = settings.completeTitle || "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ï¼";

                lastScheduledSource = settings.lastScheduledSource || 'fixed';
                isInitialSetupDone = settings.isInitialSetupDone || false;
                enableVibration = settings.enableVibration !== undefined ? settings.enableVibration : true;
            }

            // ç’°å¢ƒåˆ¥ã‚¯ãƒ©ã‚¹ã®ä»˜å¤–
            document.body.classList.remove('is-pc', 'is-pwa', 'is-mobile-browser');
            if (isStandalone) {
                document.body.classList.add('is-pwa');
            } else if (isMobile) {
                document.body.classList.add('is-mobile-browser');
            } else {
                document.body.classList.add('is-pc');
            }

            // OSåˆ¥èª˜å°ãƒ‘ã‚¹ã®é©ç”¨
            const osPathText = document.getElementById('pwaOSPathText');
            if (osPathText) {
                osPathText.textContent = isIOS ? '[è¨­å®š] > [é€šçŸ¥] > [ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒ]' : '[è¨­å®š] > [ã‚¢ãƒ—ãƒª] > [ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒ] > [é€šçŸ¥] > [å…¨èˆ¬]';
            }

            // iOSå‘ã‘: ã€Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€â†’ã€Œé€šçŸ¥ãƒãƒŠãƒ¼ã€ã«æ›¸ãæ›ãˆ
            const pwaNotifDesc = document.getElementById('pwaNotifDesc');
            if (pwaNotifDesc && isIOS) {
                pwaNotifDesc.textContent = 'é€šçŸ¥ãƒãƒŠãƒ¼ï¼ˆç”»é¢ä¸Šéƒ¨ã¸ã®é€šçŸ¥ï¼‰ã‚„ã‚µã‚¦ãƒ³ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€OSå´ã®è¨­å®šå¤‰æ›´ãŒå¿…è¦ã§ã™ã€‚';
            }
            const pwaGuidePath = document.getElementById('pwaGuidePath');
            if (pwaGuidePath && isIOS) {
                // iOSå‘ã‘ã®æ¡ˆå†…æ–‡æœ«å°¾ã‚’ã€Œé€šçŸ¥ãƒãƒŠãƒ¼ã€ã«å¯¾å¿œã—ãŸè¡¨ç¾ã¸å¤‰æ›´
                const guideEnd = pwaGuidePath.querySelector('span:not(#pwaOSPathText)');
                if (!guideEnd) {
                    // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆï¼ˆæœ€å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ï¼‰
                    const nodes = pwaGuidePath.childNodes;
                    for (let i = nodes.length - 1; i >= 0; i--) {
                        if (nodes[i].nodeType === Node.TEXT_NODE && nodes[i].textContent.trim()) {
                            nodes[i].textContent = 'ã‹ã‚‰é€šçŸ¥ãƒãƒŠãƒ¼ã€ã‚µã‚¦ãƒ³ãƒ‰ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„';
                            break;
                        }
                    }
                }
            }

            // æŒ¯å‹•è¨­å®šã®è¡¨ç¤ºåˆ¶å¾¡ (iOS PWAã§ã¯éè¡¨ç¤º)
            const vibContainer = document.getElementById('pwaVibrationContainer');
            if (vibContainer) {
                vibContainer.style.display = (isIOS && isStandalone) ? 'none' : 'block';
            }


            if (!saved || !isInitialSetupDone) {
                fixedTimes = fixedTimes.length > 0 ? fixedTimes : ['04:00', '16:00'];
                document.getElementById('initialSetupCard').style.display = 'block';
            }

            document.getElementById('cooldownInput').value = cooldownMinutes;
            document.getElementById('actionTimeInput').value = actionTimeSeconds;
            document.getElementById('initialActionTime').value = actionTimeSeconds;
            const advanceInput = document.getElementById('notificationAdvanceInput');
            if (advanceInput) advanceInput.value = notificationAdvanceSeconds;
            document.getElementById('notifyOnCompleteInput').checked = notifyOnComplete;
            document.getElementById('notificationSoundInput').checked = notificationSound;
            document.getElementById('requireInteractionInput').checked = requireInteraction;
            document.getElementById('preventFocusOnNotificationClickInput').checked = preventFocusOnNotificationClick;
            document.getElementById('showTitleTimerInput').checked = showTitleTimer;
            document.getElementById('autoUpdateNextInput').checked = autoUpdateNext;
            document.getElementById('colorPicker').value = primaryColor;

            document.getElementById('remindTitleInput').value = remindTitle;
            document.getElementById('remindBodyInput').value = remindBody;
            document.getElementById('completeTitleInput').value = completeTitle;

            const themeRadio = document.querySelector(`input[name="themeMode"][value="${themeMode}"]`);
            if (themeRadio) themeRadio.checked = true;

            toggleFocusSetting(); // UIçŠ¶æ…‹ã®åˆæœŸåŒ–
            updateFixedTimesList();
            updateTimerSystem();
            applyPrimaryColor();
            updateNotificationStatus();
            updateMuteUI();

            if (isInitialSetupDone) {
                if (nextNotificationTime && nextNotificationTime < new Date()) {
                    updateTimerLogic(true);
                } else if (!nextNotificationTime) {
                    recalculateNextNotificationTime();
                }
            }
        }

        function saveSettings() {
            if (!isInitialSetupDone && !document.getElementById('initialSetupCard').style.display === 'none') return;

            cooldownMinutes = parseInt(document.getElementById('cooldownInput').value) || 180;
            actionTimeSeconds = parseInt(document.getElementById('actionTimeInput').value) || 0;
            notificationAdvanceSeconds = parseInt(document.getElementById('notificationAdvanceInput')?.value) || 0;
            notifyOnComplete = document.getElementById('notifyOnCompleteInput').checked;
            notificationSound = document.getElementById('notificationSoundInput').checked;
            requireInteraction = document.getElementById('requireInteractionInput').checked;
            preventFocusOnNotificationClick = document.getElementById('preventFocusOnNotificationClickInput').checked;
            preventSleep = true; // å¸¸ã«ä¿å­˜
            autoUpdateNext = document.getElementById('autoUpdateNextInput').checked;

            remindTitle = document.getElementById('remindTitleInput').value || "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®æ™‚é–“ã§ã™ï¼";
            remindBody = document.getElementById('remindBodyInput').value || "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã‚’å¿˜ã‚Œãšã«â™ª";
            completeTitle = document.getElementById('completeTitleInput').value || "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒå®Œäº†ï¼";

            const themeCheck = document.querySelector('input[name="themeMode"]:checked');
            themeMode = themeCheck ? themeCheck.value : 'system';
            primaryColor = document.getElementById('colorPicker').value;

            const settings = {
                fixedTimes, cooldownMinutes, actionTimeSeconds, notificationAdvanceSeconds, notifyOnComplete, notificationSound,
                requireInteraction, preventFocusOnNotificationClick,
                preventSleep, showTitleTimer, autoUpdateNext, muteNotifications, themeMode,
                nextNotificationTime: nextNotificationTime ? nextNotificationTime.toISOString() : null,
                lastNotifiedTime: lastNotifiedTime ? lastNotifiedTime.toISOString() : null,
                lastCompletedTime: lastCompletedTime ? lastCompletedTime.toISOString() : null,
                pendingAutoUpdateTime: pendingAutoUpdateTime ? pendingAutoUpdateTime.toISOString() : null,
                isDelayedNotification,
                remindTitle, remindBody, completeTitle,
                lastScheduledSource, primaryColor, textColor, isInitialSetupDone,
                enableVibration
            };
            localStorage.setItem('cafeTouchSettings', JSON.stringify(settings));

            // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã€è¨­å®šå¤‰æ›´ã‚’å³åº§ã« Worker å´ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚‚åæ˜ ã•ã›ã‚‹
            if (isMobile && nextNotificationTime) {
                syncScheduleToWorker(nextNotificationTime);
            }
        }

        async function checkNotificationPermissionManual() {
            let lines = ['ã€é€šçŸ¥è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã€‘\n'];

            // 1. é€šçŸ¥æ¨©é™
            const perm = Notification.permission;
            const permOk = perm === 'granted';
            lines.push(`${permOk ? 'âœ…' : 'âŒ'} é€šçŸ¥æ¨©é™: ${perm}${permOk ? 'ï¼ˆOKï¼‰' : 'ï¼ˆNGï¼‰'}`);

            if (isMobile && 'serviceWorker' in navigator) {
                // 2. Pushè³¼èª­æ§‹é€ 
                let subOk = false;
                try {
                    const reg = await navigator.serviceWorker.ready;
                    const sub = await reg.pushManager.getSubscription();
                    subOk = !!sub;
                    lines.push(`${subOk ? 'âœ…' : 'âŒ'} ãƒ—ãƒƒã‚·ãƒ¥è³¼èª­: ${subOk ? 'ã‚ã‚Šï¼ˆOKï¼‰' : 'ãªã— â€” é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³ã‹ã‚‰å†ç™»éŒ²ã—ã¦ãã ã•ã„'}`);
                } catch (e) {
                    lines.push(`âŒ ãƒ—ãƒƒã‚·ãƒ¥è³¼èª­: å–å¾—ã‚¨ãƒ©ãƒ¼`);
                }

                // 3. Service Worker
                const reg2 = await navigator.serviceWorker.getRegistration();
                const swOk = !!reg2;
                lines.push(`${swOk ? 'âœ…' : 'âŒ'} Service Worker: ${swOk ? 'ç™»éŒ²æ¸ˆã¿ï¼ˆOKï¼‰' : 'æœªç™»éŒ² â€” ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„'}`);

                // 4. PWAãƒ¢ãƒ¼ãƒ‰
                lines.push(`${isStandalone ? 'âœ…' : 'â—'} PWA(ãƒ›ãƒ¼ãƒ ç”»é¢èµ·å‹•): ${isStandalone ? 'Yesï¼ˆOKï¼‰' : 'No'}`);

                // 5. OSã®é€šçŸ¥è¨­å®š(Web APIã§ã¯å–å¾—ä¸å¯)
                lines.push(`â“ OSé€šçŸ¥è¨­å®š: å–å¾—ä¸å¯ï¼ˆWebAPIã‹ã‚‰ã¯å‚ç…§ã§ãã¾ã›ã‚“ï¼‰`);

                // 6. æŒ¯å‹•è¨­å®šã®è¨ºæ–­
                lines.push('');
                lines.push(`ğŸ’¡ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚„æŒ¯å‹•ã®ã‚ªãƒ³/ã‚ªãƒ•ã¯ã€OSå´ã®è¨­å®šã§åˆ¶å¾¡ã•ã‚Œã¾ã™`);
                if (isIOS) {
                    lines.push(`   [è¨­å®š] > [é€šçŸ¥] > [ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒ]`);
                } else {
                    lines.push(`   [è¨­å®š] > [ã‚¢ãƒ—ãƒª] > [ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒ] > [é€šçŸ¥]`);
                }

                if (!permOk) {
                    lines.push(`\nâš ï¸ é€šçŸ¥æ¨©é™ãŒå¿…è¦ã§ã™ã€‚ä¸‹ã®ã€Œé€šçŸ¥ã‚’è¨±å¯ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
                }
            }

            alert(lines.join('\n'));
        }

        function saveSettingsAuto() {
            saveSettings();
        }

        function saveSettingsAndRecalculate() {
            saveSettings();
            recalculateNextNotificationTime();
        }

        function toggleFocusSetting() {
            const isRequire = document.getElementById('requireInteractionInput').checked;
            const focusContainer = document.getElementById('preventFocusContainer');
            const focusInput = document.getElementById('preventFocusOnNotificationClickInput');

            if (isRequire) {
                focusContainer.classList.remove('disabled');
                focusInput.disabled = false;
            } else {
                focusContainer.classList.add('disabled');
                focusInput.disabled = true;
            }
            saveSettings();
        }

        function setThemeMode(mode) {
            themeMode = mode;
            document.documentElement.classList.remove('theme-dark', 'theme-light');
            if (mode === 'dark') document.documentElement.classList.add('theme-dark');
            else if (mode === 'light') document.documentElement.classList.add('theme-light');
            saveSettings();
        }

        function togglePreventSleep() {
            preventSleep = document.getElementById('preventSleepInput').checked;
            updateTimerSystem();
            saveSettings();
        }

        function completeInitialSetup() {
            isInitialSetupDone = true;
            document.getElementById('initialSetupCard').style.display = 'none';
        }

        function showAddFixedTimeMode() {
            document.getElementById('showAddFixedTimeBtn').style.display = 'none';
            document.getElementById('addFixedTimeInputGroup').style.display = 'flex';
            document.getElementById('fixedTimeInput').focus();
        }

        function hideAddFixedTimeMode() {
            document.getElementById('showAddFixedTimeBtn').style.display = 'flex';
            document.getElementById('addFixedTimeInputGroup').style.display = 'none';
            document.getElementById('fixedTimeInput').value = '';
        }

        function addFixedTime() {
            const input = document.getElementById('fixedTimeInput');
            if (input.value && !fixedTimes.includes(input.value)) {
                fixedTimes.push(input.value);
                fixedTimes.sort();
                updateFixedTimesList();
                input.value = '';
                recalculateNextNotificationTime();
                hideAddFixedTimeMode();
            } else if (!input.value) {
                hideAddFixedTimeMode();
            }
        }

        function removeFixedTime(time, event) {
            const tag = event.target.closest('.time-tag');
            if (!tag) return;
            fixedTimes = fixedTimes.filter(t => t !== time);
            tag.classList.add('deleted');
            tag.style.backgroundColor = 'var(--color-control-bg)';
            tag.style.color = 'var(--color-text-secondary)';
            tag.style.boxShadow = 'none';
            tag.innerHTML = `
                <span style="opacity: 0.7; font-size: 13px;">${time} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ</span>
                <button onclick="undoDelete('${time}')" style="margin-left: 8px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; padding: 2px 8px; cursor: pointer; color: var(--color-text); font-size: 12px;">â†º å…ƒã«æˆ»ã™</button>
            `;
            setTimeout(() => {
                if (tag.parentNode && tag.classList.contains('deleted')) {
                    tag.remove();
                }
            }, 8000);
            recalculateNextNotificationTime();
        }

        function undoDelete(time) {
            if (!fixedTimes.includes(time)) {
                fixedTimes.push(time);
                fixedTimes.sort();
                updateFixedTimesList();
                recalculateNextNotificationTime();
            }
        }

        function updateFixedTimesList() {
            const list = document.getElementById('fixedTimesList');
            list.innerHTML = '';
            fixedTimes.forEach(time => {
                const tag = document.createElement('div');
                tag.className = 'time-tag';
                tag.style.backgroundColor = primaryColor;
                tag.style.color = textColor;
                const clockIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block; vertical-align:middle; margin-right:4px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
                tag.innerHTML = `${clockIcon}${time} <button onclick="removeFixedTime('${time}', event)">Ã—</button>`;
                list.appendChild(tag);
            });
        }

        function recalculateNextNotificationTime(isRetroactive = false, skipSync = false) {
            const now = new Date();
            const nextFixed = getNextFixedTime(now);

            if (lastCompletedTime) {
                const cooldownEnd = new Date(lastCompletedTime.getTime() + cooldownMinutes * 60 * 1000);
                const firstResetAfterTouch = getNextFixedTime(lastCompletedTime);

                if (firstResetAfterTouch && firstResetAfterTouch < cooldownEnd) {
                    nextNotificationTime = firstResetAfterTouch;
                    lastScheduledSource = 'fixed';
                } else {
                    nextNotificationTime = cooldownEnd;
                    lastScheduledSource = 'completed';
                }
            } else {
                if (fixedTimes.length === 0) {
                    nextNotificationTime = null;
                } else {
                    nextNotificationTime = nextFixed;
                    lastScheduledSource = 'fixed';
                }
            }

            lastNotifiedTime = null;
            pendingAutoUpdateTime = null;
            isDelayedNotification = false;
            document.getElementById('completedBtn').classList.remove('btn-emphasis');
            document.getElementById('autoUpdateBar').style.width = '0%';

            // é¡åŠç™»éŒ²æ™‚ã€ã™ã§ã«æ™‚é–“ã‚’éãã¦ã„ãŸã‚‰å³åº§ã«ã€Œé€šçŸ¥æ¸ˆã¿ã€ã«ã—ã¦ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
            if (isRetroactive && nextNotificationTime && nextNotificationTime <= now) {
                lastNotifiedTime = nextNotificationTime;
                isDelayedNotification = true;
            }

            saveSettings();
            updateTimerLogic(true);

            // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯Cloudflare Workerã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åŒæœŸã™ã‚‹
            // â˜…è‡ªå‹•æ›´æ–°(skipSync=true)ã®å ´åˆã¯ã€Workerå´ãŒæ—¢ã«ãƒã‚§ãƒ¼ãƒ³ã‚’é–‹å§‹ã—ã¦ã„ã‚‹ãŸã‚åŒæœŸã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦äºŒé‡ç™»éŒ²ã‚’é˜²ã
            if (isMobile && nextNotificationTime && !isRetroactive && !skipSync) {
                syncScheduleToWorker(nextNotificationTime);
            }
        }

        function markCompleted(isAuto = false) {
            const now = new Date();
            lastCompletedTime = now;
            recalculateNextNotificationTime(isAuto);
            if (!isAuto && notifyOnComplete) showNotification(completeTitle, `>> ${formatTime(nextNotificationTime)}`, 'complete');
        }

        async function resetTimer() {
            // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ Worker å´ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚åœæ­¢ã•ã›ã‚‹
            if (isMobile) {
                const subStr = localStorage.getItem('pushSubscription');
                if (subStr) {
                    try {
                        const subscription = JSON.parse(subStr);
                        await fetch(`${WORKER_URL}/stop`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ subscription })
                        });
                        console.log('Worker Sync: Stopped');
                    } catch (e) {
                        console.error('Worker Stop Sync Failed:', e);
                    }
                }
            }
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’å®Œå…¨ã«åœæ­¢ã™ã‚‹ï¼ˆæ¬¡ã®äºˆå®šã‚’ã‚¯ãƒªã‚¢ï¼‰
            lastCompletedTime = null;
            nextNotificationTime = null;
            lastNotifiedTime = null;
            pendingAutoUpdateTime = null;
            isDelayedNotification = false;
            saveSettings();
            updateTimerLogic(true);
        }

        function getNextFixedTime(fromTime) {
            if (fixedTimes.length === 0) return null;
            const from = new Date(fromTime);
            const today = new Date(from.getFullYear(), from.getMonth(), from.getDate());
            let nextTime = null;
            for (const timeStr of fixedTimes) {
                const [h, m] = timeStr.split(':').map(Number);
                const candidate = new Date(today);
                candidate.setHours(h, m, 0, 0);
                if (candidate > from) {
                    if (!nextTime || candidate < nextTime) nextTime = candidate;
                }
            }
            if (!nextTime) {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const [h, m] = fixedTimes[0].split(':').map(Number);
                nextTime = new Date(tomorrow);
                nextTime.setHours(h, m, 0, 0);
            }
            return nextTime;
        }

        function getPreviousFixedTime(fromTime) {
            if (fixedTimes.length === 0) return null;
            const from = new Date(fromTime);
            const today = new Date(from.getFullYear(), from.getMonth(), from.getDate());
            let prevTime = null;

            for (const timeStr of fixedTimes) {
                const [h, m] = timeStr.split(':').map(Number);
                const candidate = new Date(today);
                candidate.setHours(h, m, 0, 0);
                if (candidate < from) {
                    if (!prevTime || candidate > prevTime) prevTime = candidate;
                }
            }

            if (!prevTime) {
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const lastTimeStr = fixedTimes[fixedTimes.length - 1];
                const [h, m] = lastTimeStr.split(':').map(Number);
                prevTime = new Date(yesterday);
                prevTime.setHours(h, m, 0, 0);
            }
            return prevTime;
        }

        function updateTimerLogic(forceUpdate = false) {
            const now = new Date();
            const lastTouchText = lastCompletedTime ? formatTime(lastCompletedTime) : '00:00:00';
            const nextTouchText = nextNotificationTime ? formatTime(nextNotificationTime) : '00:00:00';

            const updateInfo = (last, status, next) => {
                updateText('lastTouchDisplay', `å‰å› ${last}`);
                updateText('statusDisplay', status);
                updateText('nextTouchDisplay', `æ¬¡å› ${next}`);

                const isReset = (!lastCompletedTime);
                document.getElementById('timer').classList.toggle('placeholder', isReset);
                document.getElementById('lastTouchDisplay').classList.toggle('placeholder', isReset);
            };

            if (!nextNotificationTime) {
                updateText('timer', '00:00:00');
                updateInfo('00:00:00', 'ã‚¿ã‚¤ãƒãƒ¼æœªè¨­å®š', 'æœªè¨­å®š');
                updateDynamicTitle();
                return;
            }

            const timeSinceScheduled = now - nextNotificationTime;
            const actionWaitMs = actionTimeSeconds * 1000;

            // 1. é€šçŸ¥ã®ç™ºä¿¡åˆ¤å®š
            if (timeSinceScheduled >= 0) {
                if (!lastNotifiedTime || lastNotifiedTime.getTime() !== nextNotificationTime.getTime()) {
                    // é…å»¶åˆ¤å®šï¼ˆè‡ªå‹•ç™»éŒ²ã‚’æ­¢ã‚ã‚‹é–¾å€¤ï¼‰: PCã¯60ç§’ã€ãƒ¢ãƒã‚¤ãƒ«ã¯300ç§’(Androidã®ã‚¹ãƒªãƒ¼ãƒ—è€ƒæ…®)
                    const delayThreshold = isMobile ? 300000 : 60000;
                    isDelayedNotification = (timeSinceScheduled > delayThreshold);

                    // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ Worker ãŒ Push é€šçŸ¥ã‚’é€ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ã¯ç™ºç«ã—ãªã„
                    if (!isMobile) {
                        showNotification(remindTitle, remindBody, 'remind');
                    }
                    lastNotifiedTime = nextNotificationTime;
                    saveSettings();
                }
            }

            // 2. æ‰‹å‹•æ“ä½œå¾…ã¡ãƒ¢ãƒ¼ãƒ‰ï¼ˆã¾ãŸã¯é¡åŠç™»éŒ²å¾Œã®å³æ™‚å¾…æ©Ÿï¼‰
            if (isDelayedNotification || (!autoUpdateNext && timeSinceScheduled >= 0)) {
                updateText('timer', '00:00:00');
                updateInfo(lastTouchText, "ã‚¿ãƒƒãƒå¾…æ©Ÿä¸­...", nextTouchText);
                updateDynamicTitle();
                document.getElementById('completedBtn').classList.add('btn-emphasis');
                document.getElementById('autoUpdateBar').style.width = '0%';
                return;
            }

            // 3. ãƒªã‚»ãƒƒãƒˆçŠ¶æ…‹
            if (!lastCompletedTime && timeSinceScheduled < 0) {
                updateText('timer', '00:00:00');
                updateInfo('00:00:00', '', nextTouchText);
                updateDynamicTitle();
                document.getElementById('autoUpdateBar').style.width = '0%';
                return;
            }

            // 4. æ“ä½œå¾…æ©Ÿä¸­
            if (timeSinceScheduled >= 0 && timeSinceScheduled < actionWaitMs) {
                const remainingWait = Math.ceil((actionWaitMs - timeSinceScheduled) / 1000);
                const progress = (timeSinceScheduled / actionWaitMs) * 100;

                updateText('timer', '00:00:00');
                updateInfo(lastTouchText, `ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒä¸­... (${remainingWait}s)`, nextTouchText);
                updateDynamicTitle();
                document.getElementById('autoUpdateBar').style.width = `${progress}%`;
                return;
            }

            // 5. è‡ªå‹•æ›´æ–°ã®å®Ÿè¡Œ
            if (timeSinceScheduled >= actionWaitMs) {
                document.getElementById('autoUpdateBar').style.width = '100%';
                lastCompletedTime = new Date(nextNotificationTime.getTime() + actionWaitMs);
                // è‡ªå‹•æ›´æ–°(skipSync=true)ã‚’æ¸¡ã—ã¦ Worker ã¸ã®äºŒé‡é€ä¿¡ã‚’é˜²æ­¢
                recalculateNextNotificationTime(false, true);
                return;
            }

            // 6. é€šå¸¸ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­
            const diff = nextNotificationTime - now;
            const cooldownMs = cooldownMinutes * 60 * 1000;
            const timeSinceLastComplete = lastCompletedTime ? (now - lastCompletedTime) : Infinity;

            let canTouchAnytime = false;
            if (lastScheduledSource === 'fixed' && diff > cooldownMs && timeSinceLastComplete > cooldownMs) {
                canTouchAnytime = true;
            }
            if (lastCompletedTime) {
                const nextResetAfterTouch = getNextFixedTime(lastCompletedTime);
                if (nextResetAfterTouch && nextResetAfterTouch <= now) {
                    canTouchAnytime = true;
                }
            }

            if (canTouchAnytime) {
                updateText('timer', '00:00:00');
                updateInfo(lastTouchText, "ã„ã¤ã§ã‚‚ã‚¿ãƒƒãƒå¯èƒ½", nextTouchText);
                updateDynamicTitle();
                document.getElementById('autoUpdateBar').style.width = '0%';
                return;
            }

            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            updateText('timer', `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`);
            updateInfo(lastTouchText, "", nextTouchText);
            updateDynamicTitle();
            document.getElementById('autoUpdateBar').style.width = '0%';
        }

        // å‹•çš„ãªã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
        function updateDynamicTitle() {
            const baseTitle = "ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼";
            if (!showTitleTimer || !isInitialSetupDone || !nextNotificationTime) {
                if (document.title !== baseTitle) document.title = baseTitle;
                return;
            }

            const now = new Date();
            const timeSinceScheduled = now - nextNotificationTime;
            const cooldownMs = cooldownMinutes * 60 * 1000;
            const timeSinceLastComplete = lastCompletedTime ? (now - lastCompletedTime) : Infinity;

            let isTouchTiming = (timeSinceScheduled >= 0) ||
                (lastScheduledSource === 'fixed' && (nextNotificationTime - now) > cooldownMs && timeSinceLastComplete > cooldownMs) ||
                (lastCompletedTime && getNextFixedTime(lastCompletedTime) <= now);

            if (isTouchTiming) {
                if (document.title !== `â˜• ${baseTitle}`) document.title = `â˜• ${baseTitle}`;
            } else {
                const diff = nextNotificationTime - now;
                const totalMinutes = Math.ceil(diff / 60000);
                const newTitle = `(${totalMinutes}åˆ†) ${baseTitle}`;
                if (document.title !== newTitle) document.title = newTitle;
            }
        }

        function updateText(id, text) {
            const el = document.getElementById(id);
            if (el && el.textContent !== text) el.textContent = text;
        }

        function formatTime(date) {
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            const s = String(date.getSeconds()).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        async function enableNotifications() {
            if (!("Notification" in window)) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                // å…ˆã«æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ï¼ˆã“ã‚ŒãŒæœ€ã‚‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå‡ºã‚„ã™ã„é †åºï¼‰
                const permission = await Notification.requestPermission();
                updateNotificationStatus();

                if (permission === 'granted') {
                    let reg = null;
                    if ('serviceWorker' in navigator) {
                        reg = await navigator.serviceWorker.register('sw.js');
                    }

                    // Push Managerã®è³¼èª­å‡¦ç†ï¼ˆãƒ¢ãƒã‚¤ãƒ«ãƒ»PCå•ã‚ãšä¸€åº¦ã—ã¦ãŠãï¼‰
                    if (reg && reg.pushManager) {
                        try {
                            const subscription = await reg.pushManager.subscribe({
                                userVisibleOnly: true,
                                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                            });
                            localStorage.setItem('pushSubscription', JSON.stringify(subscription));
                        } catch (pushErr) {
                            console.error('Push Manager Subscribe Error:', pushErr);
                        }
                    }

                    showNotification('é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼', 'ã“ã‚Œã‹ã‚‰ã‚«ãƒ•ã‚§ã‚¿ãƒƒãƒã®æ™‚é–“ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™â™ª');
                } else if (permission === 'denied') {
                    alert('é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šï¼ˆURLæ¨ªã®éµãƒãƒ¼ã‚¯ãªã©ï¼‰ã‹ã‚‰é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (err) {
                console.error('Notification error:', err);
            }
        }

        function toggleMute() {
            muteNotifications = !muteNotifications;
            updateMuteUI();
            saveSettings();
        }

        function updateMuteUI() {
            const btn = document.getElementById('muteBtn');
            const iconOn = document.getElementById('bellIconOn');
            const iconOff = document.getElementById('bellIconOff');

            if (muteNotifications) {
                btn.classList.add('muted');
                btn.classList.remove('hover-pause');
                iconOn.style.display = 'none';
                iconOff.style.display = 'block';
                btn.title = 'é€šçŸ¥ã‚’å†é–‹';
                btn.style.color = '#e34a45'; // ãƒŸãƒ¥ãƒ¼ãƒˆæ™‚ã¯èµ¤è‰²ã«å›ºå®š
            } else {
                btn.classList.remove('muted');
                btn.classList.add('hover-pause');
                iconOn.style.display = 'block';
                iconOff.style.display = 'none';
                btn.title = 'é€šçŸ¥ã‚’ä¸€æ™‚åœæ­¢';
                btn.style.color = primaryColor; // é€šå¸¸æ™‚ã¯ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«æˆ»ã™
            }
        }

        function toggleRetroactiveMode() {
            const panel = document.getElementById('retroactivePanel');
            const btn = document.getElementById('retroactiveModeBtn');
            const slider = document.getElementById('retroactiveSlider');
            const rangeLabel = document.getElementById('retroactiveRangeLabel');
            const isHidden = panel.style.display === 'none' || panel.style.display === '';

            if (isHidden) {
                panel.style.display = 'block';
                btn.style.display = 'none';
                retroactiveBaseTime = new Date();
                const now = retroactiveBaseTime;
                const lastReset = getPreviousFixedTime(now);
                let minMinutes = cooldownMinutes;

                let h_label = Math.floor(minMinutes / 60);
                let m_label = minMinutes % 60;
                let labelText = "";
                if (h_label > 0) labelText += h_label + "æ™‚é–“";
                if (m_label > 0) labelText += m_label + "åˆ†";
                let resetInfo = `(éå»${labelText}ä»¥å†…)`;

                if (lastReset) {
                    const diffToReset = Math.floor((now - lastReset) / 60000);
                    if (diffToReset < cooldownMinutes) {
                        minMinutes = diffToReset;
                        resetInfo = `ï¼ˆ${formatTime(lastReset).substring(0, 5)}ã®ãƒªã‚»ãƒƒãƒˆä»¥é™ï¼‰`;
                    }
                }

                slider.min = -minMinutes;

                const currentH = Math.floor(minMinutes / 60);
                const currentM = minMinutes % 60;
                let currentLabel = "";
                if (currentH > 0) currentLabel += currentH + "æ™‚é–“";
                if (currentM > 0) currentLabel += currentM + "åˆ†";
                document.getElementById('retroactiveSliderLabelMin').textContent = currentLabel + "å‰";

                rangeLabel.textContent = `å‰å›ã‚¿ãƒƒãƒã—ãŸæ™‚åˆ»ã‚’è¨­å®šã—ã¦ãã ã•ã„ ${resetInfo}`;
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('retroactiveTimeInput').value = `${h}:${m}`;
                slider.value = 0;
            } else {
                panel.style.display = 'none';
                btn.style.display = 'block';
                retroactiveBaseTime = null;
            }
        }

        function syncTimeFromSlider() {
            const slider = document.getElementById('retroactiveSlider');
            const timeInput = document.getElementById('retroactiveTimeInput');
            const minutesAgo = parseInt(slider.value);
            const base = retroactiveBaseTime || new Date();
            const targetTime = new Date(base.getTime() + minutesAgo * 60 * 1000);
            const h = String(targetTime.getHours()).padStart(2, '0');
            const m = String(targetTime.getMinutes()).padStart(2, '0');
            timeInput.value = `${h}:${m}`;
        }

        function syncSliderFromTime() {
            const slider = document.getElementById('retroactiveSlider');
            const timeInput = document.getElementById('retroactiveTimeInput');
            const base = retroactiveBaseTime || new Date();
            const [h, m] = timeInput.value.split(':').map(Number);
            let targetTime = new Date(base);
            targetTime.setHours(h, m, 0, 0);
            if (targetTime > base) targetTime.setDate(targetTime.getDate() - 1);
            const diffMs = targetTime - base;
            const diffMinutes = Math.round(diffMs / 60000);
            const min = parseInt(slider.min);
            const max = parseInt(slider.max);
            if (diffMinutes < min) {
                slider.value = min;
                syncTimeFromSlider();
            } else if (diffMinutes > max) {
                slider.value = max;
                syncTimeFromSlider();
            } else {
                slider.value = diffMinutes;
            }
        }

        function confirmRetroactive() {
            const timeInput = document.getElementById('retroactiveTimeInput');
            const slider = document.getElementById('retroactiveSlider');
            const base = retroactiveBaseTime || new Date();
            const [h, m] = timeInput.value.split(':').map(Number);
            let completedTime = new Date(base);
            completedTime.setHours(h, m, 0, 0);
            if (completedTime > base) completedTime.setDate(completedTime.getDate() - 1);
            const minAllowed = parseInt(slider.min);
            const diffMinutes = Math.round((completedTime - base) / 60000);
            if (diffMinutes < minAllowed) {
                completedTime = new Date(base.getTime() + minAllowed * 60 * 1000);
            } else if (diffMinutes > 0) {
                completedTime = base;
            }
            lastCompletedTime = completedTime;
            // é¡åŠç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦å†è¨ˆç®—ï¼ˆå³æ™‚é€šçŸ¥ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
            // é¡åŠç™»éŒ²æ™‚ã¯ã€æ–°ã—ã„æ™‚åˆ»ã«åŸºã¥ã„ã¦ Worker ã«é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¸Šæ›¸ãé€ä¿¡ã™ã‚‹
            recalculateNextNotificationTime(true, false);
            toggleRetroactiveMode();
            if (notifyOnComplete) {
                showNotification(completeTitle, `>> ${formatTime(nextNotificationTime)} (éå»å®Œäº†ç™»éŒ²)`, 'complete');
            }
        }

        async function resetApp() {
            if (confirm("ã™ã¹ã¦ã®è¨­å®šï¼ˆé€šçŸ¥ã®è³¼èª­ã‚„ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’å«ã‚€ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ãƒ–ãƒ©ã‚¦ã‚¶è‡ªä½“ã®ã€Œé€šçŸ¥è¨±å¯ã€ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã«ã¯ã€URLæ¨ªã®éµã‚¢ã‚¤ã‚³ãƒ³ãªã©ã‹ã‚‰æ‰‹å‹•ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚")) {
                // 1. ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è³¼èª­è§£é™¤ã‚’è©¦è¡Œ
                if ('serviceWorker' in navigator) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            // ãƒ—ãƒƒã‚·ãƒ¥è³¼èª­ãŒã‚ã‚Œã°è§£é™¤
                            const subscription = await registration.pushManager.getSubscription();
                            if (subscription) {
                                await subscription.unsubscribe();
                                console.log('Push subscription removed');
                            }
                            // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²è§£é™¤
                            await registration.unregister();
                            console.log('Service Worker unregistered');
                        }
                    } catch (e) {
                        console.error('Reset failed during SW/Push removal:', e);
                    }
                }

                // 2. localStorageã®å‰Šé™¤
                localStorage.clear();

                // 3. ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åˆæœŸçŠ¶æ…‹ã¸
                alert("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\né€šçŸ¥æ¨©é™ã‚’å®Œå…¨ã«æˆ»ã—ãŸã„å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰æ‰‹å‹•ã§ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚");
                location.reload();
            }
        }

        function updateNotificationStatus() {
            const granted = ("Notification" in window) && (Notification.permission === 'granted');
            document.documentElement.style.setProperty('--notification-request-display', granted ? 'none' : 'block');
            const statusInSettings = document.getElementById('notificationStatusInSettings');
            if (statusInSettings) {
                let statusText = granted ? 'âœ“ é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™' : 'é€šçŸ¥ãŒç„¡åŠ¹ã§ã™';
                if (granted && isStandalone) {
                    statusText = 'âœ“ ã“ã®PWAã§é€šçŸ¥ãŒæœ‰åŠ¹ã§ã™';
                }
                statusInSettings.textContent = statusText;
                statusInSettings.style.color = granted ? '' : 'var(--color-slate-500)';
            }
        }

        async function sendTestNotification() {
            if (Notification.permission !== 'granted') return alert('å…ˆã«é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„');

            // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ Cloudflare Worker çµŒç”±ã®ãƒ†ã‚¹ãƒˆé€ä¿¡
            if (isMobile) {
                const subStr = localStorage.getItem('pushSubscription');
                if (!subStr) {
                    alert('ã€è¨ºæ–­ã€‘Pushé€šçŸ¥ã®è³¼èª­æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‹ã‚‰ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\nãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªå ´åˆã¯ã€è¨­å®š â†’ ã€Œé€šçŸ¥ã‚’è¨±å¯ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    return;
                }

                try {
                    const subscription = JSON.parse(subStr);
                    const { requireInteraction: finalRequireInteraction, enableVibration: finalEnableVibration } = getNotificationSettings();

                    const resp = await fetch(`${WORKER_URL}/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            subscription,
                            payload: {
                                title: remindTitle,
                                body: remindBody + " (Push Test)",
                                requireInteraction: finalRequireInteraction,
                                enableVibration: finalEnableVibration
                            }
                        })
                    });

                    if (resp.ok) {
                        console.log('Push Test Sent OK');
                        // æˆåŠŸã—ãŸå ´åˆã¯æ•°ç§’å¾Œã«Pushé€šçŸ¥ãŒå±Šãã¯ãšã€‚ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ã¯å‡ºã•ãªã„ã€‚
                        return;
                    } else {
                        const errText = await resp.text();
                        alert(`ã€è¨ºæ–­ã€‘Worker ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ (${resp.status}):\n\n${errText.substring(0, 300)}`);
                        return;
                    }
                } catch (e) {
                    alert(`ã€è¨ºæ–­ã€‘Worker ã¸ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:\n\n${e.message}`);
                    console.error('Push test failed', e);
                    return;
                }
            }

            // PCï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼‰ç”¨ã®ãƒ†ã‚¹ãƒˆé€šçŸ¥
            showNotification(remindTitle, remindBody + " (ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆãƒ†ã‚¹ãƒˆ)", 'remind');
        }

        function showNotification(title, body, isTest = false) { // isTest ã¯ type='test' ã®ç°¡æ˜“ãƒ•ãƒ©ã‚°ã¨ã—ã¦ã‚‚æ©Ÿèƒ½(å¾Œæ–¹äº’æ›)
            const type = (isTest === true || isTest === 'test') ? 'test' : (isTest === 'remind' ? 'remind' : (isTest === 'complete' ? 'complete' : 'normal'));

            if (muteNotifications && type !== 'test') return;
            if (Notification.permission !== 'granted') return;

            // PCå‘ã‘è¨­å®šå€¤ã®å–å¾—
            const keepNotification = document.getElementById('requireInteractionInput') ? document.getElementById('requireInteractionInput').checked : false;
            const preventFocus = document.getElementById('preventFocusOnNotificationClickInput') ? document.getElementById('preventFocusOnNotificationClickInput').checked : false;

            // ãƒªãƒã‚¤ãƒ³ãƒ‰é€šçŸ¥ã‹ã¤è¨­å®šONã®æ™‚ã ã‘ requireInteraction: true (PCã®ã¿)
            // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ requireInteraction: true å›ºå®š(ã¾ãŸã¯SWä¾å­˜)ã§ã€ã‚¢ãƒ—ãƒªã‚’é–‹ãæŒ™å‹•ãŒå„ªå…ˆã•ã‚Œã‚‹
            const shouldRequireInteractionPC = (type === 'remind' && keepNotification);

            const options = {
                body: body,
                tag: 'cafe-touch-notification',
                renotify: true,
                // Androidã§ã¯éŸ³ãªã—ã«ã™ã‚‹ã¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è‡ªä½“ãŒæ¶ˆãˆã‚‹ãŸã‚ã€ãƒ¢ãƒã‚¤ãƒ«ãªã‚‰å¸¸ã«falseã€PCãªã‚‰è¨­å®šã«å¾“ã†
                silent: isMobile ? false : !notificationSound,
                requireInteraction: isMobile ? true : shouldRequireInteractionPC
            };

            if (isMobile) {
                // Android: Service WorkerçµŒç”±
                options.icon = 'favicon-96x96.png';
                options.badge = 'favicon-96x96.png';
                options.vibrate = (notificationSound) ? [200, 100, 200] : [];

                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg) {
                        reg.showNotification(title, options);
                    } else {
                        // SWãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆPCç‰ˆã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                        try {
                            const n = new Notification(title, options);
                            n.onclick = (e) => { e.preventDefault(); window.focus(); };
                        } catch (e) {
                            options.requireInteraction = false;
                            const n = new Notification(title, options);
                            n.onclick = (e) => { e.preventDefault(); window.focus(); };
                        }
                    }
                }).catch(err => {
                    console.error('SW Notification Error:', err);
                });
            } else {
                // PC: æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯é©ç”¨
                try {
                    const n = new Notification(title, options);
                    n.onclick = (e) => {
                        e.preventDefault();

                        if (shouldRequireInteractionPC) { // å¸¸é§è¨­å®šONãªã‚‰ã‚¯ãƒªãƒƒã‚¯ã§å®Œäº†
                            markCompleted();
                            if (!preventFocus) window.focus();
                        } else {
                            window.focus(); // é€šå¸¸ã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                        }
                        n.close();
                    };
                } catch (e) {
                    options.requireInteraction = false;
                    const n = new Notification(title, options);
                    n.onclick = (e) => { e.preventDefault(); window.focus(); n.close(); };
                }
            }
        }

        function setColor(color) {
            primaryColor = color;
            document.getElementById('colorPicker').value = color;
            applyPrimaryColor();
            saveSettings();
        }

        function setTextColor(color) {
            textColor = color;
            applyPrimaryColor();
            saveSettings();
        }

        function applyPrimaryColor() {
            document.documentElement.style.setProperty('--color-teal-500', primaryColor);
            document.documentElement.style.setProperty('--color-teal-300', primaryColor);
            document.documentElement.style.setProperty('--initial-color', primaryColor);
            document.documentElement.style.setProperty('--initial-text-color', textColor);

            // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚‚æ›´æ–°
            const themeMeta = document.getElementById('themeColorMeta');
            if (themeMeta) themeMeta.setAttribute('content', primaryColor);

            let r = 0, g = 0, b = 0;
            if (primaryColor.startsWith('#')) {
                r = parseInt(primaryColor.slice(1, 3), 16);
                g = parseInt(primaryColor.slice(3, 5), 16);
                b = parseInt(primaryColor.slice(5, 7), 16);
            }
            document.documentElement.style.setProperty('--color-teal-500-rgb', `${r}, ${g}, ${b}`);

            updateFixedTimesList();
            document.getElementById('timer').style.color = primaryColor;
            document.querySelector('h1').style.color = primaryColor;

            // ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã®è‰²ã‚’é©ç”¨ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã®å„ªå…ˆé †ä½ã‚’ç®¡ç†ï¼‰
            const muteBtn = document.getElementById('muteBtn');
            if (muteBtn) {
                muteBtn.style.color = muteNotifications ? '#e34a45' : primaryColor;
            }
        }

        document.addEventListener('visibilitychange', () => {
            updateNotificationStatus();
            if (document.visibilityState === 'visible') {
                setWorkerRate(200);
                updateTimerLogic(true);
            } else {
                setWorkerRate(1000);
            }
        });

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒæˆ»ã£ãŸéš›ã«ã‚‚æ¨©é™çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        window.addEventListener('focus', () => {
            updateNotificationStatus();
        });

        window.addEventListener('load', () => {
            loadSettings();

            // ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã§ã¯ç„¡æ„å‘³ãƒ»æ©Ÿèƒ½ã—ãªã„è¨­å®šã‚’éš ã—ã€è‡ªå‹•æ›´æ–°ã‚’ã‚ªãƒ•ã«ã™ã‚‹
            if (isMobile) {
                // Worker ãŒè‡ªå‹•æ¬¡å›ç™»éŒ²ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã€autoUpdateNext ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šã«å¾“ã†

                const hideIds = [
                    'notificationSoundInput', // é€šçŸ¥éŸ³(OSè¨­å®šãŒå„ªå…ˆãŸã‚)
                    'muteBtn',                // ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³(ã‚¹ãƒãƒ›ã§ã¯åˆ¶å¾¡å›°é›£ãªãŸã‚éè¡¨ç¤º)
                    'preventFocusContainer'    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦éè¡¨ç¤º(PCç”¨)
                ];

                hideIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        const group = el.closest('.checkbox-group') || el.closest('.form-group');
                        if (group) {
                            group.style.display = 'none';
                            const helpText = group.nextElementSibling;
                            if (helpText && helpText.classList.contains('help-text')) helpText.style.display = 'none';
                        } else {
                            // checkbox-group ã§ã‚‚ form-group ã§ã‚‚ãªã„è¦ç´ ï¼ˆãƒœã‚¿ãƒ³ç­‰ï¼‰ã¯ç›´æ¥éè¡¨ç¤º
                            el.style.display = 'none';
                        }
                    }
                });

                // æ“ä½œèª¬æ˜ã®æ•´ç†ï¼šå…±é€šåŒ–ã—ã€ä¸€éƒ¨ã¯ã‚¹ãƒãƒ›ã§ã‚‚ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹
                // ã‚¹ãƒãƒ›å›ºæœ‰ã®éè¡¨ç¤ºã«ã—ã¦ã„ãŸèª¬æ˜ã‚‚ã€ä»Šå›ã¯èª­ã¾ã›ã‚‹ãŸã‚ã«ä¸€éƒ¨è¡¨ç¤ºã‚’è§£é™¤ã™ã‚‹
                // ï¼ˆinstructionAutoUpdate ãªã©ã¯ãã®ã¾ã¾æ®‹ã—ã€è¨­å®šã‹ã‚‰ã„ã˜ã‚‹ã‚‚ã®ã¯å…ƒã®ã¾ã¾ï¼‰

                // ãƒ¢ãƒã‚¤ãƒ«PWAãƒ¢ãƒ¼ãƒ‰(Standalone)ãªã‚‰å°‚ç”¨ã®é€šçŸ¥è¨­å®šã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
                if (isStandalone) {
                    const titleTimerInput = document.getElementById('showTitleTimerInput');
                    if (titleTimerInput) {
                        const group = titleTimerInput.closest('.checkbox-group');
                        if (group) {
                            group.style.display = 'none';
                            const helpText = group.nextElementSibling;
                            if (helpText && helpText.classList.contains('help-text')) helpText.style.display = 'none';
                        }
                    }

                    const pwaGuide = document.getElementById('pwaAdvancedSettings');
                    if (pwaGuide) {
                        pwaGuide.style.display = 'block';
                    }
                }

            }

            // Service Workerã®è‡ªå‹•ç™»éŒ²
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(async (reg) => {
                    console.log('Service Worker Registered');
                    updateNotificationStatus();

                    // é€šçŸ¥ãŒè¨±å¯æ¸ˆã¿ã‹ã¤Pushè³¼èª­ãŒæœªç™»éŒ²ãªã‚‰ã€è‡ªå‹•ã§Pushè³¼èª­ã‚’è¡Œã†
                    if (Notification.permission === 'granted' && !localStorage.getItem('pushSubscription')) {
                        if (reg.pushManager) {
                            try {
                                const subscription = await reg.pushManager.subscribe({
                                    userVisibleOnly: true,
                                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                                });
                                localStorage.setItem('pushSubscription', JSON.stringify(subscription));
                                console.log('Push subscription auto-registered:', subscription.endpoint);
                            } catch (pushErr) {
                                console.error('Auto Push Subscribe Error:', pushErr);
                            }
                        }
                    }
                }).catch(err => console.error('SW Registration failed:', err));
            }
            document.getElementById('initialSetupCard').addEventListener('click', (e) => {
                if (e.target.id === 'initialSetupConfirmBtn') {
                    const morningInput = document.getElementById('initialMorningTime');
                    const eveningInput = document.getElementById('initialEveningTime');
                    const actionInput = document.getElementById('initialActionTime');
                    const times = [];
                    if (morningInput.value) times.push(morningInput.value);
                    if (eveningInput.value) times.push(eveningInput.value);
                    fixedTimes = times.sort();
                    actionTimeSeconds = parseInt(actionInput.value) || 0;
                    document.getElementById('actionTimeInput').value = actionTimeSeconds;
                    completeInitialSetup();
                    updateFixedTimesList();
                    recalculateNextNotificationTime();
                }
            });
            document.getElementById('showTitleTimerInput').addEventListener('change', saveSettingsAndRecalculate);
            document.getElementById('notifyOnCompleteInput').addEventListener('change', saveSettings);
            document.getElementById('notificationSoundInput').addEventListener('change', saveSettings);
            document.getElementById('requireInteractionInput').addEventListener('change', (e) => {
                toggleFocusSetting();
                saveSettings();
            });
            document.getElementById('preventFocusOnNotificationClickInput').addEventListener('change', saveSettings);
            document.getElementById('autoUpdateNextInput').addEventListener('change', saveSettings);
        });
    </script>
</body>

</html>